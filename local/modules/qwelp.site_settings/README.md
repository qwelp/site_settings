# Модуль "Настройки сайта" для 1C-Bitrix

Модуль для хранения и предоставления настроек сайта через инфоблок в формате JSON для JavaScript.

## Описание

Модуль создает инфоблок с настройками сайта, которые можно редактировать через административный интерфейс Битрикса. Настройки доступны через AJAX-запрос в формате JSON для использования на клиентской стороне.

## Установка

1. Скопируйте папку `qwelp.site_settings` в директорию `/local/modules/`
2. Установите модуль через административный интерфейс Битрикса: `Marketplace > Установленные решения > Настройки сайта`

## Структура настроек

Модуль создает инфоблок, в котором каждый элемент представляет собой одну настройку. Настройки группируются по разделам:

1. **Общие** (general)
   - ENABLE_FEATURE (Включить функцию) - чекбокс
   - LANGUAGE (Язык интерфейса) - список

2. **Внешний вид** (appearance)
   - LAYOUT_TYPE (Тип оформления) - радиокнопки
   - THEME_IMAGE (Фоновая тема) - радиокнопки с изображениями

3. **Уведомления** (notifications)
   - EMAIL_NOTIFY (Email-уведомления) - чекбокс
   - NOTIFY_FREQUENCY (Частота уведомлений) - список

4. **Безопасность** (security)
   - TWO_FACTOR (Двухфакторная аутентификация) - чекбокс
   - SESSION_TIMEOUT (Таймаут сессии) - список

5. **Интеграции** (integration)
   - ENABLE_API (Включить API-доступ) - чекбокс
   - API_MODE (Режим API) - радиокнопки

### Свойства настроек

Каждый элемент инфоблока (настройка) имеет следующие свойства:

- **TYPE** - тип элемента управления (checkbox, radio, select, radioImage)
- **VALUES** - JSON-массив вариантов для select/radio/radioImage
- **HELP_TEXT** - текст подсказки
- **HELP_IMAGE** - изображение для подсказки

Элементы привязываются к соответствующим разделам инфоблока.

### Интерактивный редактор вариантов значений

Модуль включает интерактивный редактор для управления вариантами значений (options) в административном интерфейсе. Вместо ручного редактирования JSON-строки, администратор может использовать удобный интерфейс:

- Таблица с колонками "Значение" и "Метка" (для radioImage добавляется колонка "Изображение")
- Кнопки для добавления новых вариантов
- Кнопки для перемещения вариантов вверх/вниз (изменение порядка)
- Кнопки для удаления вариантов

Редактор автоматически сериализует данные в JSON-формат и сохраняет их в скрытом поле при отправке формы.

### Гибкость и расширяемость

Администратор может добавлять новые настройки через стандартный интерфейс Битрикса:

1. Создать новый элемент в инфоблоке
2. Указать название и символьный код
3. Заполнить свойства (тип, варианты значений, подсказки и т.д.)

Новые настройки автоматически появятся в JSON-ответе и будут доступны на клиентской стороне.

## Использование в JavaScript

Для получения настроек в JavaScript используйте AJAX-запрос:

```javascript
// Пример получения настроек
fetch('/local/modules/qwelp.site_settings/ajax/get_settings.php')
  .then(response => response.json())
  .then(settings => {
    console.log(settings);
    // Используйте полученные настройки
  })
  .catch(error => console.error('Ошибка при получении настроек:', error));
```

Для получения настроек для конкретного сайта (в многосайтовой конфигурации):

```javascript
fetch('/local/modules/qwelp.site_settings/ajax/get_settings.php?site_id=s1')
  .then(response => response.json())
  .then(settings => {
    console.log(settings);
  });
```

## Формат возвращаемых данных

```json
{
  "sections": [
    {
      "id": "general",
      "title": "Общие",
      "settings": [
        {
          "code": "ENABLE_FEATURE",
          "label": "Включить функцию",
          "type": "checkbox",
          "helpText": "Включает основную функциональность модуля.",
          "helpImage": "/upload/iblock/123/help-general.png",
          "options": null
        },
        {
          "code": "LANGUAGE",
          "label": "Язык интерфейса",
          "type": "select",
          "helpText": "Выберите язык для отображения всех подписей.",
          "helpImage": null,
          "options": [
            {"value": "ru", "label": "Русский"},
            {"value": "en", "label": "English"},
            {"value": "de", "label": "Deutsch"}
          ]
        }
      ]
    },
    {
      "id": "appearance",
      "title": "Внешний вид",
      "settings": [
        {
          "code": "LAYOUT_TYPE",
          "label": "Тип оформления",
          "type": "radio",
          "helpText": "Переключает между светлой и тёмной темой.",
          "helpImage": "/upload/iblock/456/help-appearance.png",
          "options": [
            {"value": "light", "label": "Светлый"},
            {"value": "dark", "label": "Тёмный"}
          ]
        }
      ]
    }
  ]
}
```

Пример содержит только два раздела и не все настройки. В реальном ответе будут присутствовать все 5 разделов настроек со всеми настройками.

## Использование в PHP

Для работы с настройками в PHP используйте класс `SettingsManager`:

```php
use Bitrix\Main\Loader;
use Qwelp\SiteSettings\SettingsManager;

// Подключаем модуль
Loader::includeModule('qwelp.site_settings');

// Получаем настройки для текущего сайта
$settings = SettingsManager::getSettings();

// Получаем настройки для конкретного сайта
$settings = SettingsManager::getSettings('s1');

// Получаем настройки в формате JSON
$jsonSettings = SettingsManager::getSettingsJson();

// Получаем отдельный параметр по его коду
$parameter = SettingsManager::getParameter('ENABLE_FEATURE');

// Получаем отдельный параметр из конкретного раздела
$parameter = SettingsManager::getParameter('LANGUAGE', 'general');

// Получаем только значение параметра
$value = SettingsManager::getParameterValue('ENABLE_FEATURE');

// Получаем значение параметра с указанием значения по умолчанию
$value = SettingsManager::getParameterValue('LANGUAGE', 'ru');

// Сохраняем настройки
$data = [
    'sections' => [
        [
            'id' => 'general',
            'settings' => [
                [
                    'code' => 'ENABLE_FEATURE',
                    'type' => 'checkbox',
                    'helpText' => 'Включает основную функциональность модуля.',
                    'helpImage' => '/img/help-general.png'
                ],
                [
                    'code' => 'LANGUAGE',
                    'type' => 'select',
                    'helpText' => 'Выберите язык для отображения всех подписей.',
                    'options' => [
                        ['value' => 'ru', 'label' => 'Русский'],
                        ['value' => 'en', 'label' => 'English'],
                        ['value' => 'de', 'label' => 'Deutsch']
                    ]
                ]
            ]
        ]
    ]
];
SettingsManager::saveSettings('s1', $data);
```

### Добавление новых настроек через PHP

Вы также можете программно добавлять новые настройки:

```php
use Bitrix\Main\Loader;
use Bitrix\Main\Application;

// Подключаем модуль инфоблоков
Loader::includeModule('iblock');

// Получаем ID инфоблока
$iblockRes = \CIBlock::GetList(
    [],
    [
        'CODE' => 'site_settings',
        'TYPE' => 'site_settings',
        'CHECK_PERMISSIONS' => 'N'
    ]
);

if ($iblock = $iblockRes->Fetch()) {
    $iblockId = (int)$iblock['ID'];

    // Создаем новую настройку
    $el = new \CIBlockElement;
    $elementFields = [
        'IBLOCK_ID' => $iblockId,
        'NAME' => 'Новая настройка',
        'CODE' => 'NEW_SETTING',
        'ACTIVE' => 'Y',
        'SORT' => 300
    ];

    $elementId = $el->Add($elementFields);

    if ($elementId) {
        // Устанавливаем свойства элемента
        $propValues = [
            'TYPE' => 'checkbox',
            'HELP_TEXT' => 'Описание новой настройки',
            'SECTION_ID' => 'general'
        ];

        \CIBlockElement::SetPropertyValuesEx($elementId, $iblockId, $propValues);
    }
}
```

## Миграция с предыдущей версии

Если вы обновляете модуль с предыдущей версии, вам необходимо выполнить скрипт миграции для преобразования данных из старой структуры в новую:

1. Откройте файл `/local/modules/qwelp.site_settings/migrate.php` в браузере
2. Скрипт автоматически:
   - Создаст новые свойства для элементов инфоблока (TYPE, VALUES, HELP_TEXT, HELP_IMAGE, SECTION_ID)
   - Создаст новые элементы для каждой настройки с соответствующими свойствами
   - Удалит старые свойства инфоблока
   - Удалит старые элементы-разделы

После выполнения миграции вы увидите отчет о выполненных действиях.

## Многосайтовость

Модуль поддерживает многосайтовую конфигурацию Битрикса. При запросе настроек для конкретного сайта, если настройки для этого сайта отсутствуют, будут возвращены настройки по умолчанию.

## Требования

- 1C-Bitrix версии 14.0.0 или выше
- Модуль "Информационные блоки" (iblock)

## Особенности административного интерфейса

### Интерактивный редактор вариантов значений

При редактировании элемента инфоблока с настройками, свойство VALUES отображается в виде интерактивного редактора:

1. **Таблица вариантов значений**:
   - Для типов radio и select: колонки "Значение" и "Метка"
   - Для типа radioImage: колонки "Значение", "Метка" и "Изображение"

2. **Управление вариантами**:
   - Кнопка "Добавить вариант" для создания новой строки
   - Кнопки ↑/↓ для изменения порядка вариантов
   - Кнопка ✕ для удаления варианта

3. **Автоматическая сериализация**:
   - При любом изменении данные автоматически преобразуются в JSON
   - JSON сохраняется в скрытом поле формы
   - При отправке формы сохраняется актуальная версия данных

Это значительно упрощает работу администратора с настройками, особенно при большом количестве вариантов или при использовании типа radioImage.
